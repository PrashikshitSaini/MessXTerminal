<!DOCTYPE html>
<html>
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Terminal Chat</title>
    <link rel="stylesheet" href="https://unpkg.com/xterm/css/xterm.css" />
    <script src="https://unpkg.com/xterm/lib/xterm.js"></script>
    <script src="https://unpkg.com/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <style>
      body,
      html {
        height: 100%;
        margin: 0;
        padding: 0;
        background-color: #000;
        overflow: hidden;
      }
      #term {
        height: 100%;
        width: 100%;
      }
      /* Mobile keyboard button */
      #keyboard-btn {
        position: fixed;
        bottom: 10px;
        right: 10px;
        z-index: 100;
        background: rgba(255, 255, 255, 0.7);
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        font-size: 20px;
      }
      #username-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      #username-form {
        background: #333;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        width: 80%;
        max-width: 300px;
      }
      #username-input {
        padding: 12px;
        margin: 15px 0;
        width: 100%;
        box-sizing: border-box;
        border: none;
        border-radius: 5px;
        font-size: 16px;
      }
      #username-submit {
        padding: 12px 0;
        background: #0b93f6;
        border: none;
        color: white;
        cursor: pointer;
        border-radius: 5px;
        width: 100%;
        font-size: 16px;
      }
      #username-error {
        color: #ff6b6b;
        margin-top: 10px;
        min-height: 20px;
      }
    </style>
  </head>
  <body>
    <div id="username-modal">
      <div id="username-form">
        <h2 style="color: white">Enter Your Name</h2>
        <input
          type="text"
          id="username-input"
          placeholder="Your name here"
          maxlength="15"
        />
        <button id="username-submit">Start Chatting</button>
        <div id="username-error"></div>
      </div>
    </div>

    <div id="term"></div>
    <button id="keyboard-btn">⌨️</button>

    <script>
      const term = new Terminal({
        cursorBlink: true,
        fontSize: 14,
        fontFamily: 'Menlo, Monaco, "Courier New", monospace',
        theme: {
          background: "#000",
        },
      });

      const fitAddon = new FitAddon.FitAddon();
      term.loadAddon(fitAddon);
      term.open(document.getElementById("term"));
      fitAddon.fit();

      window.addEventListener("resize", () => {
        fitAddon.fit();
      });

      // Detect if we're on HTTPS and connect securely
      const isSecure = window.location.protocol === "https:";
      const socket = io({
        secure: isSecure,
        transportOptions: {
          polling: {
            extraHeaders: {
              "X-Client-Type": "browser",
            },
          },
        },
      });

      let myUsername = "";
      let buffer = "";

      // Function to check if a message is a server log message
      function isServerLogMessage(text) {
        return (
          text.includes("Running on") ||
          text.includes("development server") ||
          text.includes("Press CTRL+C") ||
          text.includes("WARNING:") ||
          text.includes("http://127.0.0.1") ||
          text.includes("all addresses") ||
          text.match(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}/)
        );
      }

      // Show the prompt at the bottom
      function showPrompt() {
        term.write(`${myUsername}> `);
      }

      // Get formatted date and time based on device's location
      function getLocalDateTime() {
        const now = new Date();

        // Format: [DD/MM/YYYY: HH:MM]
        const day = String(now.getDate()).padStart(2, "0");
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const year = now.getFullYear();
        const hours = String(now.getHours()).padStart(2, "0");
        const minutes = String(now.getMinutes()).padStart(2, "0");

        return `[${day}/${month}/${year}: ${hours}:${minutes}]`;
      }

      // Get time in multiple timezones
      function getMultipleTimezones() {
        const now = new Date();

        // UTC Time
        const utcHours = String(now.getUTCHours()).padStart(2, "0");
        const utcMinutes = String(now.getUTCMinutes()).padStart(2, "0");
        const utcTime = `UTC: ${utcHours}:${utcMinutes}`;

        // Indian Standard Time (UTC+5:30)
        const istDate = new Date(now.getTime() + 5.5 * 60 * 60 * 1000);
        const istHours = String(istDate.getUTCHours()).padStart(2, "0");
        const istMinutes = String(istDate.getUTCMinutes()).padStart(2, "0");
        const istTime = `IST: ${istHours}:${istMinutes}`;

        // Central Time (CT) - automatically handles CDT vs CST
        // Create a date object for US Central Time
        const ctOptions = {
          timeZone: "America/Chicago",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        };
        const ctTimeStr = now.toLocaleTimeString("en-US", ctOptions);
        const ctTime = `CT: ${ctTimeStr}`;

        return `${utcTime} | ${istTime} | ${ctTime}`;
      }

      // Handle special commands
      function handleSpecialCommands(message) {
        if (message === "clear") {
          // Clear the terminal screen
          term.clear();
          return true;
        } else if (message === "@exit") {
          // Disconnect and return to login screen
          socket.disconnect();
          document.getElementById("username-modal").style.display = "block";
          term.clear();
          term.writeln("Terminal Chat - Connect with friends!");
          term.writeln("Please enter your username to begin.");
          myUsername = "";
          buffer = "";
          return true;
        } else if (message === "@time") {
          // Show time in different timezones
          const timeInfo = getMultipleTimezones();
          term.write("\r\x1B[K");
          term.writeln(timeInfo);
          showPrompt();
          return true;
        } else if (message === "@users") {
          // Request user list from server
          socket.emit("get_users");
          return true;
        }
        return false;
      }

      // Handle sending a message
      function sendMessage(message) {
        if (!message.trim()) return;

        // Handle special commands
        if (handleSpecialCommands(message)) {
          return;
        }

        // Clear the current line before sending
        term.write("\r\x1B[K");

        // Send to server with timestamp
        const timestamp = getLocalDateTime();
        socket.emit("chat", { message, timestamp });
      }

      // Submit username
      document
        .getElementById("username-submit")
        .addEventListener("click", () => {
          const username = document
            .getElementById("username-input")
            .value.trim();
          const errorDiv = document.getElementById("username-error");

          if (!username) {
            errorDiv.textContent = "Please enter a name";
            return;
          }

          myUsername = username;
          socket.emit("join", { username });
        });

      // Terminal keyboard input
      term.onKey((e) => {
        const { key, domEvent } = e;

        if (domEvent.key === "Enter") {
          // Send the current message
          if (buffer.trim()) {
            const message = buffer;
            buffer = "";

            // Send message
            sendMessage(message);
          }

          // Always clear the line and start fresh
          term.write("\r\x1B[K");
          showPrompt();
        } else if (domEvent.key === "Backspace") {
          if (buffer.length) {
            buffer = buffer.slice(0, -1);
            term.write("\b \b");
          }
        } else if (key.length === 1) {
          buffer += key;
          term.write(key);
        }
      });

      // Socket events
      socket.on("system_message", (data) => {
        if (data.message.startsWith("Error:")) {
          document.getElementById("username-error").textContent = data.message;
        } else {
          document.getElementById("username-modal").style.display = "none";

          // Save current line content
          const currentInput = buffer;

          // Clear the current line
          term.write("\r\x1B[K");

          // Show welcome or other system messages
          if (!isServerLogMessage(data.message)) {
            term.writeln(data.message);
          }

          // Show the prompt and restore what was being typed
          showPrompt();
          if (currentInput) {
            buffer = currentInput;
            term.write(currentInput);
          }
        }
      });

      socket.on("chat_message", (data) => {
        const sender = data.sender;
        const message = data.message;
        const timestamp = data.timestamp || getLocalDateTime();

        // Skip server logs
        if (isServerLogMessage(message)) {
          return;
        }

        // Save current line content
        const currentInput = buffer;

        // Clear the current line
        term.write("\r\x1B[K");

        // Format and display the message with timestamp
        let displayText;
        if (sender === "System") {
          displayText = `${timestamp} ${message}`; // System messages like "** user joined **"
        } else if (sender === "History") {
          displayText = message; // History messages from log (already have timestamps)
        } else {
          displayText = `${timestamp} [${sender}] ${message}`;
        }

        term.writeln(displayText);

        // Show the prompt and restore what was being typed
        showPrompt();
        if (currentInput) {
          buffer = currentInput;
          term.write(currentInput);
        }
      });

      // Handle user list response
      socket.on("user_list", (data) => {
        const users = data.users;
        const currentInput = buffer;

        // Clear the current line
        term.write("\r\x1B[K");

        // Display user list
        term.writeln("=== Connected Users ===");
        users.forEach((user, index) => {
          term.writeln(`${index + 1}. ${user}`);
        });
        term.writeln("=====================");

        // Show the prompt and restore what was being typed
        showPrompt();
        if (currentInput) {
          buffer = currentInput;
          term.write(currentInput);
        }
      });

      socket.on("connect", () => {
        term.writeln("Terminal Chat - Connect with friends!");
        term.writeln("Please enter your username to begin.");
        document.getElementById("username-input").focus();
      });

      // Mobile keyboard button handler
      document.getElementById("keyboard-btn").addEventListener("click", () => {
        if (!myUsername) {
          document.getElementById("username-input").focus();
          return;
        }

        const input = document.createElement("input");
        input.style.position = "absolute";
        input.style.opacity = 0;
        input.style.height = "0px";
        document.body.appendChild(input);
        input.focus();

        input.addEventListener("input", (e) => {
          const lastChar = e.target.value.slice(-1);
          if (lastChar) {
            buffer += lastChar;
            term.write(lastChar);
          }
          if (e.target.value.length > 1) {
            e.target.value = e.target.value.slice(-1);
          }
        });

        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            if (buffer.trim()) {
              const message = buffer;
              buffer = "";

              // Send message
              sendMessage(message);
            }

            // Clear line and show prompt again
            term.write("\r\x1B[K");
            showPrompt();

            input.value = "";
            e.preventDefault();
          } else if (e.key === "Backspace") {
            if (buffer.length) {
              buffer = buffer.slice(0, -1);
              term.write("\b \b");
            }
            e.preventDefault();
          }
        });
      });
    </script>
  </body>
</html>
